name: Deploy Labs Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_WORKERS_PROD }}
  DOPPLER_PROJECT: ${{ secrets.DOPPLER_PROJECT_NAME }}
  DOPPLER_CONFIG: ${{ secrets.DOPPLER_CONFIG_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Doppler CLI
        run: curl -Ls https://cli.doppler.com/install.sh | sudo sh

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Sync secrets to Cloudflare
        run: |
          set -euo pipefail
          secrets_json=$(doppler secrets download --no-file --format json --project "${DOPPLER_PROJECT:-labs}" --config "${DOPPLER_CONFIG:-production}")
          export CLOUDFLARE_API_TOKEN=$(echo "$secrets_json" | jq -r '.CLOUDFLARE_API_TOKEN')
          export CLOUDFLARE_ACCOUNT_ID=$(echo "$secrets_json" | jq -r '.CLOUDFLARE_ACCOUNT_ID')
          echo "Syncing secrets to Cloudflare Pages"
          echo "$secrets_json" | jq -r 'to_entries[] | @base64' | while read -r row; do
            key=$(echo "$row" | base64 --decode | jq -r '.key')
            value=$(echo "$row" | base64 --decode | jq -r '.value')
            # Skip Doppler-provided runtime metadata we don't want as Pages secrets
            if [[ "$key" == NODE_VERSION ]] || [[ "$key" == CLOUDFLARE_API_TOKEN ]] || [[ "$key" == CLOUDFLARE_ACCOUNT_ID ]] || [[ "$key" == CF_API_KEY ]]; then
              continue
            fi
            printf '%s\n' "$value" | npx wrangler pages secret put "$key" --project-name labs >/dev/null
          done

      - name: Deploy to Cloudflare Pages
        run: |
          doppler run --project "${DOPPLER_PROJECT:-labs}" --config "${DOPPLER_CONFIG:-production}" -- \
            npx wrangler pages deploy dist --project-name labs --commit-dirty=true
